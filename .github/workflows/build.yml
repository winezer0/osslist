name: Build and Release

on:
  # 手动触发工作流
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number'
        required: true
        default: 'v1.0.0'
  # 当创建 tag 时触发
  push:
    tags:
      - 'v*.*.*'
  # 当创建 release 时触发
  release:
    types:
      - created

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build Windows binary
        run: |
          mkdir -p bin
          GOOS=windows GOARCH=amd64 go build -o bin/osslist.exe ./cmd/osslist

      - name: Build Linux binary
        run: |
          GOOS=linux GOARCH=amd64 go build -o bin/osslist ./cmd/osslist

      - name: Get version
        id: get_version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            echo "VERSION=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.release.tag_name }}" != "" ]; then
            echo "VERSION=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref_name }}" != "" ]; then
            echo "VERSION=${{ github.ref_name }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=v1.0.0" >> $GITHUB_OUTPUT
          fi

      - name: Create Release and Upload Assets
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // 定义版本号
            const version = '${{ steps.get_version.outputs.VERSION }}';
            
            // 定义资产信息
            const assets = [
              {
                path: './bin/osslist.exe',
                name: 'osslist-windows-amd64.exe',
                contentType: 'application/octet-stream'
              },
              {
                path: './bin/osslist',
                name: 'osslist-linux-amd64',
                contentType: 'application/octet-stream'
              }
            ];
            
            let releaseId;
            let uploadUrl;
            
            // 根据触发事件类型处理
            if (context.eventName === 'workflow_dispatch' || context.eventName === 'push') {
              // 创建新的 release
              const release = await github.rest.repos.createRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag_name: version,
                name: `Release ${version}`,
                draft: false,
                prerelease: false
              });
              
              releaseId = release.data.id;
              uploadUrl = release.data.upload_url;
              console.log(`Created release ${releaseId} with upload URL: ${uploadUrl}`);
            } else if (context.eventName === 'release') {
              // 使用现有的 release
              releaseId = context.payload.release.id;
              uploadUrl = context.payload.release.upload_url;
              console.log(`Using existing release ${releaseId} with upload URL: ${uploadUrl}`);
            } else {
              console.error('Unknown event type:', context.eventName);
              return;
            }
            
            // 上传资产
            for (const asset of assets) {
              if (fs.existsSync(asset.path)) {
                const content = fs.readFileSync(asset.path);
                console.log(`Uploading asset: ${asset.name}`);
                
                await github.rest.repos.uploadReleaseAsset({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  release_id: releaseId,
                  name: asset.name,
                  data: content,
                  headers: {
                    'content-type': asset.contentType,
                    'content-length': content.length
                  }
                });
                
                console.log(`Uploaded asset: ${asset.name}`);
              } else {
                console.error(`Asset not found: ${asset.path}`);
              }
            }
            
            console.log('All assets uploaded successfully!');